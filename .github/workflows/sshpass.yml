name: SSH

on:
  workflow_dispatch: # Manual trigger
  schedule:
    - cron: '7 5 */30 * *'

jobs:
  execute-commands:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSHPass
        run: sudo apt-get update && sudo apt-get install -y sshpass jq

      - name: Execute command on remote servers
        env:
          SERVERS_JSON: ${{ secrets.SSH_JSON }}
        run: |
          # 将 JSON 字符串转换为数组并循环处理每个服务器
          echo "$SERVERS_JSON" | jq -c '.[]' | while IFS= read -r server; do
            # 提取服务器信息
            username=$(echo "$server" | jq -r '.username')
            password=$(echo "$server" | jq -r '.password')
            ssh=$(echo "$server" | jq -r '.ssh')

            # 执行 SSH 命令并捕获输出
            echo "Executing command on $username@$ssh"
            output=$(sshpass -p "$password" ssh -o StrictHostKeyChecking=no "$username@$ssh" "pwd" 2>&1)

            # 输出命令结果
            echo "$output"

            # 检查命令是否成功
            if [[ $? -ne 0 ]]; then
              echo "Error executing command on $username@$ssh"
            else
              echo "Successfully executed command on $username@$ssh"
            fi
            
            # 等待 5 秒以避免对服务器的过快请求
            echo "Waiting for 5 seconds before proceeding to the next server..."
            sleep 5
          done
