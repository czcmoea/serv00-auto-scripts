name: SSH

on:
  workflow_dispatch:
  schedule:
    - cron: '15 2 1 * *'  # 每月的 2:15 AM 执行

jobs:
  ssh-job:
    runs-on: ubuntu-latest
    env:
      pythonLocation: '/opt/hostedtoolcache/Python/3.12.7/x64'
      LD_LIBRARY_PATH: '/opt/hostedtoolcache/Python/3.12.7/x64/lib'

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install jq and sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y jq sshpass

      - name: Execute command on remote servers
        run: |
          echo "${{ secrets.SSH_JSON }}" | jq -c '.[]' | while IFS= read -r server; do
            username=$(echo $server | jq -r '.username')
            password=$(echo $server | jq -r '.password')
            ssh_host=$(echo $server | jq -r '.ssh')
            echo "Connecting to $ssh_host as $username"
            sshpass -p "$password" ssh -o StrictHostKeyChecking=no "$username@$ssh_host" "pwd"
          done
