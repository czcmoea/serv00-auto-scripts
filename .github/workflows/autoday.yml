jobs:
  execute-commands:
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSHPass
        run: sudo apt-get update && sudo apt-get install -y sshpass jq

      - name: Execute command on remote servers
        env:
          DAY_JSON: ${{ secrets.DAY_JSON }}
        run: |
          echo "$DAY_JSON" | jq -c '.[]' | while read -r server; do
            username=$(echo "$server" | jq -r '.username')
            password=$(echo "$server" | jq -r '.password')
            ssh=$(echo "$server" | jq -r '.ssh')
            cmd=$(echo "$server" | jq -r '.cmd')

            # Create a temporary file for the output
            temp_file=$(mktemp)

            {
              # Execute the command and capture output
              output=$(sshpass -p "$password" ssh -o StrictHostKeyChecking=no "$username@$ssh" "$cmd" 2>&1)
              echo "Output from $ssh:" >> "$temp_file"
              echo "$output" >> "$temp_file"
            } &

            # Store the temp file name for later use
            temp_files+=("$temp_file")
          done
          wait

          # Consolidate all outputs into output.log
          for file in "${temp_files[@]}"; do
            cat "$file" >> output.log
            rm "$file" # Clean up the temporary file
          done
